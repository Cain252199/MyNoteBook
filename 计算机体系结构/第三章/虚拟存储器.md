## 虚拟存储器
> _又称虚拟存储系统，虚拟存储体系。主要由**主存储器和外部存储器**共同组成_ <p>
> _主存储器通常用DRAM：容量小，速度快_ <p>
> _外部存储器通常由磁盘存储器：容量大，速度慢_

### 1. 虚拟存储器工作原理
_这里页式存储器为例_
* 概念：
  * 页\
    把主存储器、磁盘存储器和虚拟存储器都划分成固定大小的块(在页式存储器中称作页)
    > 主存储器的页称为实页，虚拟存储器称为虚页
  * 地址：\
    主存地址A = 实页号p + 页内偏移d \
    虚拟地址Av= 用户号U + 虚页号P + 页内偏移D
* 流程
    1. 用户程序先给出多用户虚拟地址Av
    2. 由操作系统和硬件共同对 Av 进行内部地址变换
    3. 若变换成功，则得到主存地址A；之后用A访问主存储器，获取数据
    4. 若变换失败，则表示数据不在主存储器中，必须访问磁盘存储器
    5. 由软件对 Av 进行外部地址变换，获取磁盘存储器地址
    6. 查主存实页表，看主存储器中是否有空页
    7. 若主存储器存在空页，把磁盘储存器中所要访问数据的所在页调入到主存储器的空页上
    8. 若主存储器中没有空页，则采用页面替换算法。将主存储器中暂时不用的一页写回磁盘存储器中，之后再执行上一步
    <div class = "imgalign">
    <img src = "./图片/页式虚拟存储器工作原理.png" width = 80% style = "border-radius:2%">
    </div> 

### 2. 地址的映像与变换
- 虚拟存储器中的地址空间
  - 虚拟地址空间 ----------->虚拟地址-------->应用程序员编写程序的地址空间
  - 主存储器地址空间 ------>主存储器地址
  - 辅存地址空间 ----------->磁盘地址

- 地址映像：把虚拟地址空间映象到主存地址空间
  > 用虚拟地址编写的程序按照某种规则装入主存储器的同时，建立虚拟地址与主存实地址的对应关系
- 地址变换\
  在程序运行时，把多用户虚拟地址变换成主存储器地址（内部变换）或磁盘存储器地址（外部变换）  
> *根据采用的地址映像和地址变换的不同，可以分成三种虚拟存储器：页式虚拟存储器，段式虚拟存储器，段页式虚拟存储器*
- 段式虚拟存储器
  ---
    > 段表：一个段表控制一个程序
        >> - 位置：通常放置在主存储器中；若段表太长，则把暂时不用的放置到磁盘中
        >> - 内容：段号 + 程序段长度 + 在主存中的起始地址 + 其他信息

    > 段表基址寄存器堆
        >> - 位置：位于CPU中
        >> - 段表基址寄存器：每个程序对应一个段表基址寄存器
        >> - 内容：段表基址寄存器 = 段表的长度 + 段表的起始地址 

  ---
  - 目的：满足程序员将程序分段，并通过名称或序号访问特定程序段的要求
  - 地址映像方法：将每一道程序由一个段表控制，每个程序段在段表中占一行，程序段的长度是可以任意长(区别于页虚拟存储器)
    > 示例图：
    > <div class = "imgalign">
    > <img src = "./图片/段式存储器映射表.png" width = "55%" style = "border-radius:2.5%">
    > </div>

  - 地址变换
    - 流程：
      - 通过虚拟地址的用户号U在段表基址寄存器堆中找到相应的基址寄存器
      - 从该寄存器中读出段表的起始地址
      - 段表起始地址 + 虚拟地址中的段号 = 程序段的段表地址
      - 访问程序段的段表地址，获取程序段的全部信息（包括程序段的起始地址）
      - 程序段的起始地址 + 虚拟地址中的偏移地址 = 主存储器实地址
    - 示例图：
    <div class = "imgalign">
    <img src = "./图片/段式存储器地址变换.png" width = 66% style = "border-radius:2.5%">
    </div> 
    
    > 段长和访问方式是来保护程序段\
    > 装入位表示：起始地址是在磁盘中还是在主存储器中
  - 主要优点：
    - 程序的模块化性能好
    - 便于程序和数据的共享
    - 程序的动态链接和调度比较容易
    - 便于实现信息保护
  - 主要缺点：
    - 地址变换所花费的时间比较长
    - 主存储器的利用率往往比较低
    - 对辅存的管理比较困难
  
- 页式虚拟存储器
  - 页：把虚拟地址空间和主存储器的地址空间划分成一个个固定大小的块，每块称为页。是一种逻辑上的划分，由系统管理软件任意指定。
  - 地址映像：
    <div class = "imgalign">
    <img src = "./图片/页式虚拟存储器地址映像.png" width = 66% style = "border-radius:2.5%"> 
    </div>
  - 地址变换：
    <div class = "imgalign">
    <img src = "./图片/页式存储器地址变换.png" width = 66% style ="border-radius:2.5%">
    </div>
  - 主要优点：
    - 主存储器的利用率比较高
    - 页表相对比较容易实现
    - 地址映像和变换的速度比较快
    - 对辅存的管理比较简单
  - 主要缺点：
    - 程序的模块化性能不好
    - 页表很长，需要占用很大的存储空间
  
- 段页式虚拟存储器
  - 目的：为了同时获得段式虚拟存储器在程序模块化方面的优点和页式虚拟存储器在管理主存和辅存物理空间方面的优点
  - 基本思想：对用户编写程序的虚拟空间采用分段的方法管理，而对主存储器的物理空间采用分页的方法管理

### 3. 加快内部地址变换的方法
### 4. 页面替换算法及其实现
### 5. 提高主存命中率的方法



<style>
.imgalign{
    //border:1px solid red;
    padding-top:3.5px;
    margin-left:30px
}
</style>