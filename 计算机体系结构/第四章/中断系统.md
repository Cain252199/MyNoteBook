# 中断系统
## 中断源的组织
> 中断系统的复杂性是由中断源的多样性引起的
### 中断源的种类
1. 由外围设备引起的中断
   > 低速外围设备：数据缓冲器准备好接受或发送数据\
   > 高速外围设备：DMA完成一个数据块传送后的处理工作\
   > 外围设备的启动和停止，输入输出过程中任意一个环节出现错误等

2. 由处理机产生的中断
   > 程序错误引起的，如算术运算操作溢出等。
   
3. 由存储器产生的中断
   > 非法地址，动态随机存储器（DRAM）刷新，主存储器页面失效等

4. 由控制器产生的中断
   > 非法指令，未定义的操作码，堆栈溢出等

5. 由总线产生的中断
6. 实时过程控制产生的中断
7. 实时钟的定时中断
8. 多处理机系统中，从其他处理机发送来的中断，控制台开关中断等
9.  程序调试过程中，执行完一条指令或程序运行到一个事先设置的中断点时，通过中断进入监控程序，以便对被调试程序进行跟踪或监测
10. 硬件故障中断
11. 电源故障中断


### 中断源的分类组织
- 目的：为了在响应中断后处理机能够尽快的找到中断入口，以便为中断源提供服务
- IBM的分类
   1. 重新启动中断
      > 处理机不能禁止这类中断
   2. 机器校验出错中断
      > 主要包括电源故障，运算器误动作，主存储器校验错，输入输出通道硬件故障及处理机的其他各种故障\
      > 中断处理主要是记录中断的原因及其严重程度
   3. 程序性错误引起的中断
   4. 访问管理程序中断
      > 当用户执行访管指令引起的中断，处理机一般不能禁止这类中断
   5. 外部事件中断
      > 用于计时，计费，控制的定时器中断；与其他机器和系统联系的外来信号中断；操作员对机器进行干预的中断键的中断

   6. 输入输出中断
      > 用于处理机管理各种外围设备，管理通道处理机等

- 可屏蔽中断和不可屏蔽中断
  - 也称一般中断和异常中断
  - 可屏蔽中断：可以通过软件屏蔽的中断
  - 不可屏蔽中断：不可以通过软件屏蔽的中断
    > 不可屏蔽中断一旦申请中断，处理机必定会响应\
    > 异常中断包含：自陷中断，故障中断，失效中断 

### 中断优先级
- 决定因素
  - 中断源的紧迫性
  - 设备的工作速度
  - 数据恢复的难易程度
  - 要求处理机提供的服务量

- 实现方式：硬件的排队器   
  - 当有多个中断源同时请求中断服务时，优先级高的中断源先被处理机响应
  - 处理机在执行某一级别的中断源服务程序的时候，只有比它高级的中断源的中断请求才能中断其服务程序
> **中断优先级实际上只在处理机响应中断源的中断服务请求时使用**，即在所有请求中断服务的中断源中选择出一个优先级最高的中断源首先为它服务。而**处理机在执行中断源的中断服务程序时，并没有优先级的区分**

## 中断系统的软硬件功能分配
> 中断系统中的软硬件功能分配主要考虑的两个因素：中断响应时间和灵活性\
> 中断处理过程 课本 图4.8

### 中断响应时间：
- 定义：从一个中断源向处理机发出中断服务请求开始，到处理机实际开始执行这个中断源的中断服务程序的时间
- 影响因素：
  - 最长指令执行时间
    > 在一条指令执行期间，一般不允许被中断\
    > 考虑最坏情况，即最长指令的执行时间\
    > 指令系统设计时考虑的
  - 在一条指令执行完成后，处理其他更紧急的任务所用时间
  - 从第一次‘关CPU中断’到第一次‘开CPU中断’所经历的时间
    > 占响应时间的主要部分，中断系统的软件与硬件分配主要就是考虑这段时间内所要做的事情用软件实现还是用硬件实现
  - 多个中断源同时请求中断服务程序时，通过软件找到相关中断源的中断服务程序入口所经历的时间

### 识别中断源的查询法
> 所需的硬件简单，几乎全部用软件实现
- 步骤：
  - 所有中断源公用一条中断请求线
    > 一般采用“线或”的办法实现
  - 转入公共中断服务程序入口
    > 在得到处理机的中断响应之后，隐含执行一条无条件间址指令
  - 用软件逐个测试中断源的状态
    > 按照中断优先级检查每个中断源的DONE位是否被置位，或BUSY位是否被清除
- 优点：灵活性好
- 缺点：速度慢，特别是在中断源比较多的时候

### 识别中断源的串行排队链法和中断向量法
串行排队链法
- 目的：为了提高识别中断源大的速度，使用硬件来完成中断源的排队
- 实现方法：
  - 设置一个中断请求寄存器
    - 每个中断源在中断请求中占据相应的一位，并按照中断的优先级从高到低的顺序排列
    - 当一个中断源请求中断服务时，中断请求寄存器中相应位置置“1”，否则相应位为“0”
    - 用软件与硬件相结合的方法，最终通过一条按位扫描指令找到所有请求中断服务的中断源中，具有最高优先级的中断源的相对编号

  - 使用硬件的串行排队器和编码器
    - 用硬件找到所有申请中断服务程序中，具有最高优先级的中断源的相对编号
    - 电路图 课本P226 图4.11
  
  - 中断向量法
    - 前边两种方法，都需要软件对中断源编号进行判断，并跳转到相应中断服务程序入口
    - 中断向量法：用硬件的方式找到对应中断源并跳转到相应中断服务程序入口
- 串行排队链法的特点： 用硬件固定各个中断源的中断优先级，并采用串行排队链来识别中断源
- 优点：节省了用程序逐个测试中断源的时间，实现简单
- 缺点：灵活性差；若一个中断源出现故障，则整个串行排队链就都不能正常工作，即可靠性差
  
### 识别中断源的独立请求法
- 目的：克服串行排队链法可靠性差的缺点
- 基本原理：各个中断源使用自己独立的中断请求线INIR，每一中断请求线在处理机中都有固定的或可编程的优先级。
> 独立请求法实际上是把分布在各个中断源内的串行排队器都集中到处理机中，从而克服串行排队链法可靠性差的缺点

>分组独立请求法：
>- 当中断源比较多时，常把独立请求法与串行排队链表法结合起来
>- 把中断源分组，组内采用串行排队链法，组间采用独立请求法

### 中断现场的保存和恢复
1. 现场信息分类
   1. 程序计数器PC中的内容
      - 必须由硬件保存到主存储器中的固定单元中或压入到系统堆栈中
      - 通过执行中断返回指令恢复
      - 在发生中断嵌套时，要通过程序来执行处理
  
   2. 当前程序状态的有关信息
      - 主要与当前正在运行的程序相关的信息，也称硬件现场
      - 一般采用硬件保存这类信息
      - 保存方法
        - 保存到主存储器的固定区域
        - 压入系统堆栈
        - 交换处理机状态字
   3. 在中断服务程序中将要被破坏的通用寄存器中内容
      - 又称为软件现场，大部分机器采用软件来保存和恢复

## 中断屏蔽
- 优点：部分解决快速识别中断源和灵活性之间的矛盾
- 设置中断屏蔽的三个用处：
  1. 在中断优先级已经由硬件确定了的情况下，改变中断源的中断服务顺序
    > 屏蔽较高优先级中断源的服务申请，执行较低优先级中断源的服务申请
  2. 决定设备是否采用中断方式工作
    > 让某些外围设备不采用中断方式工作，而采用程序控制方式或DMA方式工作
  3. 在多处理机系统中，可以通过中断屏蔽，把对外围设备的输入输出服务工作分配到各个处理机中
- 两种方法：
  1. 为每一个或每级中断源设置一个中断判断屏蔽位
    > 中断屏蔽位可以分布在各个中断源中，也可以集中存放在处理机中
    > 由专门的指令来管理中断屏蔽位
      > - 中断屏蔽位为‘1’时，表示对应的中断源不能请求中断服务
      > - 中断屏蔽位为‘0’时，表示对应的中断源可以请求中断服务
  
  2. 改变处理机优先级方法
    > - 处理机状态字里边存放的程序中断优先级字段，可以通过软件修改
    > - 在处理机中设置一个处理机状态字; 处理机本身中断优先级为‘0’
    > - 为每一个中断源分别建立处理机状态字，存放于主存储器的一个固定区域中
    > - 当处理机响应某一中断服务请求后，把属于该中断源的处理机状态字作为当前处理机的状态字，即当前处理机的优先级
    > - 只有当中断源的硬件中断优先级高于当前处理机的（状态字）中断优先级时，才响应该中断服务请求

  - 两种方法的对比
    - 概念不同：第一种使用的时中断屏蔽，第二种使用的是中断优先级
    - 前者为每一个中断源设置一个中断屏蔽位，所需位数较多；后者表示中断优先级所使用的位数要少
    - 前者使用比后者方便